<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Letters for Kasil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Caveat:wght@600&family=Padauk:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Padauk", "Cormorant Garamond", serif;
        background-image: linear-gradient(
            rgba(0, 0, 0, 0.4),
            rgba(0, 0, 0, 0.4)
          ),
          url("https://images.unsplash.com/photo-1502472584811-0a2f2feb8968?auto=format&fit=crop&w=1920&q=80");
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        color: #f5f3ef;
      }

      /* Floating hearts animation */
      .floating-hearts {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
      }

      .heart-float {
        position: absolute;
        color: rgba(255, 182, 193, 0.6);
        font-size: 12px;
        animation: floatUp 15s linear infinite;
        pointer-events: none;
      }

      /* Starfield background */
      .stars {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
      }

      .star {
        position: absolute;
        background: white;
        border-radius: 50%;
        animation: twinkle 3s infinite;
      }

      #letter-list-container,
      #letter-viewer-container {
        background-color: rgba(26, 26, 26, 0.65);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        animation: fadeIn 1.5s ease-out forwards;
      }

      .letter-link {
        transition: background-color 0.3s ease;
        position: relative;
      }
      .letter-link:hover {
        background-color: rgba(255, 255, 255, 0.05);
      }
      .letter-link.unread {
        border-left: 4px solid #ef4444; /* Red border */
        background-color: rgba(239, 68, 68, 0.1); /* Red background */
      }
      .letter-link.favorited {
        border-left: 4px solid #f472b6; /* Pink border */
        background-color: rgba(244, 114, 182, 0.1); /* Pink background */
      }
      .letter-link.favorited.unread {
        border-left: 4px solid #f472b6; /* Pink border */
        background: linear-gradient(
          90deg,
          rgba(244, 114, 182, 0.15),
          /* Pink gradient start */ rgba(239, 68, 68, 0.1)
            /* Red gradient end */
        );
      }

      .letter-title {
        font-family: "Cormorant Garamond", serif;
      }

      .letter-date {
        font-family: "Cormorant Garamond", serif;
        font-size: 0.9rem;
        color: #b0a99f;
      }

      .action-btn {
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        margin-left: 4px;
      }
      .action-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
      }

      /* --- MODIFIED FOR RED THEME --- */
      .action-btn.favorite {
        color: #e22929; /* Keep strong red for favorite icon */
        border-color: rgba(226, 41, 41, 0.4); /* Red border */
      }
      .action-btn.favorite:hover {
        background-color: rgba(226, 41, 41, 0.2); /* Red hover background */
      }
      .action-btn.read {
        color: #f472b6; /* Pink to match favorite border */
        border-color: rgba(244, 114, 182, 0.4); /* Pink border */
      }
      .action-btn.read:hover {
        background-color: rgba(244, 114, 182, 0.2); /* Pink hover background */
      }
      /* --- END MODIFICATION --- */

      .petal {
        position: absolute;
        top: -20px;
        background-color: #e58e8e;
        border-radius: 50% 10%;
        opacity: 0.7;
        animation: fall linear infinite;
      }

      #new-letter-modal {
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background-color: #1a1a1a;
        animation: fadeIn 0.5s ease-out;
      }

      .share-btn {
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: background-color 0.3s;
      }
      .share-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }

      .signature {
        font-family: "Caveat", cursive;
        color: #f7d794;
      }
      .heart {
        color: #e58e8e;
        text-shadow: 0 0 10px rgba(229, 142, 142, 0.5);
        animation: pulse 2.5s infinite;
      }

      .letter-body p {
        margin-bottom: 1.25rem;
      }

      @media (max-width: 640px) {
        #letter-viewer-container {
          padding: 1.5rem;
          margin: 1rem;
        }
        .letter-body,
        .letter-body p {
          font-size: 1rem;
          line-height: 1.9rem;
        }
        .signature {
          font-size: 2.25rem;
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fall {
        to {
          transform: translateY(105vh) rotate(360deg);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.8;
        }
        50% {
          transform: scale(1.1);
          opacity: 1;
        }
      }

      @keyframes floatUp {
        0% {
          opacity: 0;
          transform: translateY(100vh) rotate(0deg);
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          opacity: 0;
          transform: translateY(-100px) rotate(360deg);
        }
      }

      @keyframes twinkle {
        0%,
        100% {
          opacity: 0.3;
          transform: scale(1);
        }
        50% {
          opacity: 1;
          transform: scale(1.2);
        }
      }
    </style>
  </head>
  <body class="flex items-center justify-center min-h-screen">
    <div class="stars" id="stars"></div>
    <div class="floating-hearts" id="floating-hearts"></div>

    <main
      id="letter-list-container"
      class="w-full max-w-2xl m-4 sm:m-6 rounded-lg shadow-2xl"
    >
      <header class="p-8 text-center">
        <h1 class="letter-title text-4xl sm:text-5xl text-white">For Kasil</h1>
        <p class="text-gray-300 mt-2 italic">From my heart to yours</p>
      </header>
      <div
        id="letters-container"
        class="py-2 border-y border-gray-700/50 min-h-[120px]"
      >
        <p id="loading-state" class="text-center p-8 text-gray-400">
          Loading letters...
        </p>
      </div>
      <footer class="text-center p-6 text-xs text-gray-400">
        <p>With love, always.</p>
        <p id="user-id-display" class="mt-2 opacity-50"></p>
      </footer>
    </main>

    <main
      id="letter-viewer-container"
      class="w-full max-w-2xl p-8 sm:p-12 lg:p-16 rounded-lg leading-loose m-4 sm:m-6 hidden"
    >
      <div id="letter-content-container"></div>
      <button
        id="back-to-list-btn"
        class="inline-block mt-8 text-pink-400 hover:text-pink-300 transition-colors"
      >
        &larr; Back to all letters
      </button>
    </main>

    <button
      id="add-letter-btn"
      class="fixed bottom-6 right-6 bg-pink-500 hover:bg-pink-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg transition-transform transform hover:scale-110 hidden"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-6 w-6"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 4v16m8-8H4"
        />
      </svg>
    </button>

    <div
      id="new-letter-modal"
      class="fixed inset-0 w-full h-full flex items-center justify-center hidden"
    >
      <div
        class="modal-content w-full max-w-lg m-4 p-8 rounded-lg shadow-2xl border border-gray-700"
      >
        <h2 class="letter-title text-3xl text-white mb-6">New Letter</h2>
        <form id="new-letter-form">
          <input
            type="text"
            id="letter-title-input"
            placeholder="Letter Title"
            class="w-full p-3 bg-gray-800 border border-gray-600 rounded-md mb-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-pink-500"
            required
          />
          <textarea
            id="letter-content-input"
            placeholder="Write your heart out..."
            rows="10"
            class="w-full p-3 bg-gray-800 border border-gray-600 rounded-md mb-6 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-pink-500"
            required
          ></textarea>
          <div class="flex justify-end gap-4">
            <button
              type="button"
              id="cancel-btn"
              class="py-2 px-6 bg-gray-600 hover:bg-gray-700 rounded-md text-white transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="py-2 px-6 bg-pink-500 hover:bg-pink-600 rounded-md text-white transition-colors"
            >
              Save Letter
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      // Firebase Imports
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        doc,
        getDoc,
        addDoc,
        updateDoc,
        onSnapshot,
        query,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- Firebase Configuration ---
      const firebaseConfig = {
        apiKey: "AIzaSyCHrI_AI8ZlzoNxzrUan8V2MG6zyVPYLwQ",
        authDomain: "letters-c2152.firebaseapp.com",
        projectId: "letters-c2152",
        storageBucket: "letters-c2152.firebasestorage.app",
        messagingSenderId: "915154455185",
        appId: "1:915154455185:web:c144b5f2574023dc354d30",
        measurementId: "G-N38ZDH6VL0",
      };
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- UI Elements ---
      const letterListContainer = document.getElementById(
        "letter-list-container"
      );
      const letterViewerContainer = document.getElementById(
        "letter-viewer-container"
      );
      const lettersContainer = document.getElementById("letters-container");
      const letterContentContainer = document.getElementById(
        "letter-content-container"
      );
      const backToListBtn = document.getElementById("back-to-list-btn");
      const addBtn = document.getElementById("add-letter-btn");
      const modal = document.getElementById("new-letter-modal");
      const cancelBtn = document.getElementById("cancel-btn");
      const newLetterForm = document.getElementById("new-letter-form");
      const loadingState = document.getElementById("loading-state");
      const userIdDisplay = document.getElementById("user-id-display");

      let currentUserId = null;

      // --- Helper Functions ---
      function copyToClipboard(text, btn) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand("copy");
          const originalText = btn.textContent;
          btn.textContent = "Copied!";
          btn.disabled = true;
          setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
          }, 2000);
        } catch (err) {
          console.error("Copy failed", err);
          alert("Could not copy link.");
        }
        document.body.removeChild(textArea);
      }

      // --- View Switching Logic ---
      function showListView() {
        letterViewerContainer.classList.add("hidden");
        letterListContainer.classList.remove("hidden");
        addBtn.classList.add("hidden");
      }

      backToListBtn.addEventListener("click", showListView);

      // --- Modal Logic ---
      addBtn.addEventListener("click", () => modal.classList.remove("hidden"));
      cancelBtn.addEventListener("click", () => modal.classList.add("hidden"));
      modal.addEventListener("click", (e) => {
        if (e.target === modal) modal.classList.add("hidden");
      });

      // --- Firebase Authentication and Data Handling ---
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUserId = user.uid;
          //   userIdDisplay.textContent = `Admin Session: ${currentUserId.substring(
          //     0,
          //     8
          //   )}...`;

          const lettersColRef = collection(
            db,
            "artifacts",
            appId,
            "public",
            "data",
            "letters"
          );

          onSnapshot(query(lettersColRef), (snapshot) => {
            loadingState.style.display = "none";
            lettersContainer.innerHTML = "";
            if (snapshot.empty) {
              lettersContainer.innerHTML = `<p class="text-center p-8 text-gray-400">No letters written yet. Click the '+' to begin.</p>`;
            } else {
              // Sort letters: favorites first, then by creation date
              const letters = [];
              snapshot.docs.forEach((doc) => {
                const letter = doc.data();
                letters.push({ id: doc.id, ...letter });
              });

              letters.sort((a, b) => {
                // Favorites first
                if (a.favorited && !b.favorited) return -1;
                if (!a.favorited && b.favorited) return 1;

                // Then sort by date (newest first)
                const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                return dateB - dateA;
              });

              letters.forEach((letter) => {
                const letterEl = document.createElement("div");
                let className = "letter-link";
                if (letter.favorited) className += " favorited";
                if (!letter.read) className += " unread";
                letterEl.className = className;

                const date = letter.createdAt
                  ? letter.createdAt.toDate().toLocaleDateString("en-US", {
                      year: "numeric",
                      month: "long",
                      day: "numeric",
                    })
                  : "Just now";

                const readStatus = letter.read ? "✓" : "●";
                const favoriteIcon = letter.favorited ? "♥" : "♡";

                letterEl.innerHTML = `
                  <div class="p-4 sm:p-6 flex justify-between items-center">
                    <div class="cursor-pointer flex-grow" data-id="${
                      letter.id
                    }">
                      <div class="flex items-center gap-2">
                        <span class="text-sm ${
                          letter.read ? "text-pink-400" : "text-red-400"
                        }">${readStatus}</span>
                        <span class="letter-title text-lg sm:text-xl text-gray-200">${
                          letter.title
                        }</span>
                        ${
                          letter.favorited
                            ? '<span class="text-pink-400">♥</span>'
                            : ""
                        }
                      </div>
                      <span class="letter-date block mt-1">${date}</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <button data-id="${
                        letter.id
                      }" data-action="favorite" class="action-btn favorite" title="Toggle Favorite">${favoriteIcon}</button>
                      <button data-id="${
                        letter.id
                      }" data-action="read" class="action-btn read" title="Mark as ${
                  letter.read ? "Unread" : "Read"
                }">${readStatus}</button>
                     
                    </div>
                  </div>
                `;
                lettersContainer.appendChild(letterEl);
              });
            }
          });

          lettersContainer.addEventListener("click", async (e) => {
            const idElement = e.target.closest("[data-id]");
            if (!idElement) return;
            const letterId = idElement.dataset.id;
            const action = e.target.dataset.action;

            if (action === "share") {
              const path = window.location.pathname;
              const dir = path.substring(0, path.lastIndexOf("/") + 1);
              const shareUrl = `${window.location.origin}${dir}letter.html?id=${letterId}`;
              copyToClipboard(shareUrl, e.target);
            } else if (action === "favorite") {
              try {
                const letterRef = doc(
                  db,
                  "artifacts",
                  appId,
                  "public",
                  "data",
                  "letters",
                  letterId
                );
                const letterDoc = await getDoc(letterRef);
                if (letterDoc.exists()) {
                  const currentData = letterDoc.data();
                  await updateDoc(letterRef, {
                    favorited: !currentData.favorited,
                  });
                }
              } catch (error) {
                console.error("Error updating favorite status:", error);
              }
            } else if (action === "read") {
              try {
                const letterRef = doc(
                  db,
                  "artifacts",
                  appId,
                  "public",
                  "data",
                  "letters",
                  letterId
                );
                const letterDoc = await getDoc(letterRef);
                if (letterDoc.exists()) {
                  const currentData = letterDoc.data();
                  await updateDoc(letterRef, {
                    read: !currentData.read,
                  });
                }
              } catch (error) {
                console.error("Error updating read status:", error);
              }
            } else {
              // Mark as read when opening letter
              try {
                const letterRef = doc(
                  db,
                  "artifacts",
                  appId,
                  "public",
                  "data",
                  "letters",
                  letterId
                );
                await updateDoc(letterRef, { read: true });
              } catch (error) {
                console.error("Error marking as read:", error);
              }
              //   showLetterView(letterId);
              window.location.href = `letter.html?id=${letterId}`;
            }
          });

          newLetterForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const title = document.getElementById("letter-title-input").value;
            const content = document.getElementById(
              "letter-content-input"
            ).value;
            try {
              await addDoc(lettersColRef, {
                title,
                content,
                createdAt: serverTimestamp(),
                read: false,
                favorited: false,
              });
              newLetterForm.reset();
              modal.classList.add("hidden");
            } catch (error) {
              console.error("Error adding document: ", error);
              alert("Could not save the letter. Please try again.");
            }
          });
        }
      });

      // --- Sign In Logic ---
      async function authenticateUser() {
        try {
          if (
            typeof __initial_auth_token !== "undefined" &&
            __initial_auth_token
          ) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }
        } catch (error) {
          console.error("Authentication failed:", error);
          loadingState.textContent = "Could not authenticate. Please refresh.";
        }
      }
      authenticateUser();

      // --- Background Animations ---

      // Create starfield
      function createStars() {
        const starsContainer = document.getElementById("stars");
        for (let i = 0; i < 50; i++) {
          const star = document.createElement("div");
          star.className = "star";
          star.style.left = Math.random() * 100 + "%";
          star.style.top = Math.random() * 100 + "%";
          star.style.width = star.style.height = Math.random() * 2 + 1 + "px";
          star.style.animationDelay = Math.random() * 3 + "s";
          star.style.animationDuration = Math.random() * 3 + 2 + "s";
          starsContainer.appendChild(star);
        }
      }

      // Create floating hearts
      function createFloatingHearts() {
        const heartsContainer = document.getElementById("floating-hearts");

        function addHeart() {
          const heart = document.createElement("div");
          heart.className = "heart-float";
          heart.innerHTML = "♥";
          heart.style.left = Math.random() * 100 + "%";
          heart.style.fontSize = Math.random() * 15 + 8 + "px";
          heart.style.animationDuration = Math.random() * 8 + 12 + "s";
          heart.style.animationDelay = Math.random() * 5 + "s";
          heartsContainer.appendChild(heart);

          setTimeout(() => {
            if (heart.parentNode) {
              heart.parentNode.removeChild(heart);
            }
          }, 15000);
        }

        setInterval(addHeart, 3000);

        for (let i = 0; i < 3; i++) {
          setTimeout(addHeart, i * 2000);
        }
      }

      // Enhanced romantic petals
      function createPetals() {
        const container = document.body;
        if (document.querySelector(".petal")) return;

        for (let i = 0; i < 20; i++) {
          const petal = document.createElement("div");
          petal.className = "petal";
          const size = Math.random() * 8 + 4;
          petal.style.width = `${size}px`;
          petal.style.height = `${size}px`;
          petal.style.left = `${Math.random() * 100}vw`;
          petal.style.animationDuration = `${Math.random() * 6 + 8}s`;
          petal.style.animationDelay = `${Math.random() * 7}s`;
          container.appendChild(petal);
        }
      }

      // Initialize all elements
      window.onload = () => {
        createStars();
        createFloatingHearts();
        createPetals();
      };
    </script>
  </body>
</html>
